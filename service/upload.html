<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>文件上传 | poyoho</title>
    <meta name="description" content="blog">
    <link rel="stylesheet" href="/shared/assets/style.3d4e16a3.css">
    <link rel="modulepreload" href="/shared/assets/Home.677887dc.js">
    <link rel="modulepreload" href="/shared/assets/app.82ec9553.js">
    <link rel="modulepreload" href="/shared/assets/service_upload.md.4e5acb2e.lean.js">
    <link rel="modulepreload" href="/shared/assets/app.82ec9553.js">
    <meta name="twitter:title" content="文件上传 | poyoho">
    <meta property="og:title" content="文件上传 | poyoho">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme"><header class="nav-bar" data-v-5df6160f><div class="sidebar-button" data-v-5df6160f><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z" class></path></svg></div><a class="nav-bar-title" href="/shared/" aria-label="poyoho, back to home" data-v-5df6160f data-v-8dbfef3c><img class="logo" src="/shared/logo.svg" alt="Logo" data-v-8dbfef3c> poyoho</a><div class="flex-grow" data-v-5df6160f></div><div class="nav" data-v-5df6160f><nav class="nav-links" data-v-5df6160f data-v-38e3b123><!--[--><div class="item" data-v-38e3b123><div class="nav-link" data-v-38e3b123 data-v-45eb32c6><a class="item" href="/shared/service/index" data-v-45eb32c6>service <!----></a></div></div><div class="item" data-v-38e3b123><div class="nav-link" data-v-38e3b123 data-v-45eb32c6><a class="item" href="/shared/util/index" data-v-45eb32c6>util <!----></a></div></div><!--]--><!----><!----></nav></div><!--[--><!--]--></header><aside class="sidebar" data-v-58e261f2><nav class="nav-links nav" data-v-58e261f2 data-v-38e3b123><!--[--><div class="item" data-v-38e3b123><div class="nav-link" data-v-38e3b123 data-v-45eb32c6><a class="item" href="/shared/service/index" data-v-45eb32c6>service <!----></a></div></div><div class="item" data-v-38e3b123><div class="nav-link" data-v-38e3b123 data-v-45eb32c6><a class="item" href="/shared/util/index" data-v-45eb32c6>util <!----></a></div></div><!--]--><!----><!----></nav><!--[--><!--]--><ul class="sidebar-links" data-v-58e261f2><!--[--><li class="sidebar-link"><a class="sidebar-link-item active" href="/shared/service/upload">大文件上传</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#内容hash计算">内容hash计算</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#抽样hash">抽样hash</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#worker">worker</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#wasm">wasm</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#wasm-worker">wasm + worker</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#切片上传">切片上传</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#动态切片">动态切片</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#网络请求【并发、错误重试】请求控制">网络请求【并发、错误重试】请求控制</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#断点续传">断点续传</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#标记断点-hash计算worker">标记断点 - hash计算worker</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#标记断点-上传任务队列">标记断点 - 上传任务队列</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#续传">续传</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#canvas实现进度条">canvas实现进度条</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="/shared/service/pagination-select">跨页选择器</a><!----></li><!--]--></ul><!--[--><!--]--></aside><!-- TODO: make this button accessible --><div class="sidebar-mask"></div><main class="page" data-v-d36a7fda><div class="container" data-v-d36a7fda><!--[--><!--]--><div class="content" data-v-d36a7fda><div data-v-d36a7fda><h1 id="文件上传"><a class="header-anchor" href="#文件上传" aria-hidden="true">#</a> 文件上传</h1><ul><li><a href="https://github.com/poyoho/shared/tree/master/packages/service/upload" target="_blank" rel="noopener noreferrer">上传服务</a></li><li><a href="https://github.com/poyoho/shared/blob/master/playground/vue/src/views/uploadLargeFile.vue" target="_blank" rel="noopener noreferrer">vue用例</a></li><li><a href="https://github.com/poyoho/shared/blob/master/playground/serve/src/serve.ts" target="_blank" rel="noopener noreferrer">上传服务端</a></li></ul><h2 id="内容hash计算"><a class="header-anchor" href="#内容hash计算" aria-hidden="true">#</a> 内容hash计算</h2><p>通过文件内容<code>hash</code>，确定文件上传状态【未上传、上传中、已经上传】。</p><blockquote><ul><li><code>文件hash</code>计算需要特比资源进行运算，<code>web worker</code>（使计算不阻塞主线程UI） / <code>WebAssembly</code>（使用rust计算md5<code>速度提高30%</code>） 充分利用计算资源。</li><li>对文件hash进行<code>抽样计算</code>，损失hash的准确率（当两个文件抽样的部分完全相同，则误判两个文件相同）提高速率（减少hash计算量，速度提高<code>100% - 取决于抽样率</code>）。</li></ul></blockquote><h3 id="抽样hash"><a class="header-anchor" href="#抽样hash" aria-hidden="true">#</a> 抽样hash</h3><p>首尾不切片，其他抽样切片，使用<code>generator</code>处理中间抽样过程。</p><table><thead><tr><th>常量</th><th>简介</th><th>默认值</th></tr></thead><tbody><tr><td>FILE_OFFSET</td><td>hash计算分片</td><td>50M</td></tr><tr><td>CHUNK_OFFSET</td><td>抽样跨度</td><td>5M</td></tr><tr><td>CALC_CHUNK</td><td>计算chunk大小</td><td>1M</td></tr></tbody></table><p>一个2G的文件计算量就是</p><p>= ( 头尾 ) + ( 2G 6M采样1M )</p><p>= ( 50 + 50 ) + ( (2 * 1024 - 100) / 6 ) * 1 = <code>425M</code></p><p>计算量减少了80%，相应的速率也提高了<code>80%</code>。 而且当文件带上更多业务属性，大文件重复的几率是特别小的，文件hash的计算效率提高一个级别。</p><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">bloomFilter</span><span class="token punctuation">(</span>file<span class="token operator">:</span> File<span class="token punctuation">)</span><span class="token operator">:</span> AsyncGenerator<span class="token operator">&lt;</span><span class="token punctuation">{</span>
  buff<span class="token operator">:</span> Uint8Array<span class="token punctuation">,</span>
  endPtr<span class="token operator">:</span> <span class="token builtin">number</span>
<span class="token punctuation">}</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">const</span> chunkCount <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>size <span class="token operator">/</span> <span class="token constant">FILE_OFFSET</span><span class="token punctuation">)</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> cur <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> cur <span class="token operator">&lt;</span> file<span class="token punctuation">.</span>size<span class="token punctuation">;</span> cur <span class="token operator">+=</span> <span class="token constant">FILE_OFFSET</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> endPtr <span class="token operator">=</span> cur <span class="token operator">+</span> <span class="token constant">FILE_OFFSET</span>
    <span class="token keyword">const</span> fileChunk <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>cur<span class="token punctuation">,</span> endPtr<span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> chunkCount <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> chunks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> samplingCur <span class="token operator">=</span> cur<span class="token punctuation">;</span> samplingCur <span class="token operator">&lt;</span> endPtr<span class="token punctuation">;</span> samplingCur <span class="token operator">+=</span> <span class="token constant">CHUNK_OFFSET</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        chunks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fileChunk<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>samplingCur <span class="token operator">-</span> cur<span class="token punctuation">,</span> <span class="token constant">CALC_CHUNK</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">yield</span> <span class="token punctuation">{</span> buff<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span>chunks<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">arrayBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> endPtr <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">yield</span> <span class="token punctuation">{</span> buff<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token keyword">await</span> fileChunk<span class="token punctuation">.</span><span class="token function">arrayBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> endPtr <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    count<span class="token operator">++</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h3 id="worker"><a class="header-anchor" href="#worker" aria-hidden="true">#</a> worker</h3><p>CPU密集型的算法会阻塞UI，使用<code>web worker</code>计算hash。</p><p>算法计算内容切片，每完成一部分都通知刷新进度条。</p><div class="language-js line-numbers-mode"><pre><code><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> file <span class="token punctuation">}</span> <span class="token operator">=</span> e<span class="token punctuation">.</span>data
  <span class="token keyword">const</span> spark <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">this<span class="token punctuation">.</span>SparkMD5<span class="token punctuation">.</span>ArrayBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> fileChunksIteror <span class="token operator">=</span> <span class="token function">bloomFilter</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> fileChunk <span class="token operator">=</span> <span class="token keyword">await</span> fileChunksIteror<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fileChunk<span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">break</span> <span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> buff<span class="token punctuation">,</span> endPtr <span class="token punctuation">}</span> <span class="token operator">=</span> fileChunk<span class="token punctuation">.</span>value
    spark<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>buff<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      action<span class="token operator">:</span> <span class="token string">&quot;percent&quot;</span><span class="token punctuation">,</span>
      percent<span class="token operator">:</span> endPtr <span class="token operator">&gt;</span> file<span class="token punctuation">.</span>size <span class="token operator">?</span> <span class="token number">99</span> <span class="token operator">:</span> endPtr <span class="token operator">*</span> <span class="token number">100</span> <span class="token operator">/</span> file<span class="token punctuation">.</span>size<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    action<span class="token operator">:</span> <span class="token string">&quot;percent&quot;</span><span class="token punctuation">,</span>
    percent<span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
    hash<span class="token operator">:</span> spark<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>创建worker</p><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">function</span> <span class="token function">callWorker</span> <span class="token punctuation">(</span>
  importScripts<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token function-variable function">formatScript</span><span class="token operator">:</span> <span class="token punctuation">(</span>str<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function-variable function">string</span> <span class="token operator">=</span> <span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> str
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> workerScript <span class="token operator">=</span> _worker<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> workerData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span>
    <span class="token punctuation">[</span>
      <span class="token operator">...</span>importScripts<span class="token punctuation">,</span>
      <span class="token function">formatScript</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">(function </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>workerScript<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)()</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token operator">:</span> <span class="token string">&quot;text/javascript&quot;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span>workerData<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><blockquote><p>在调用worker的时候，将本地函数字符串化，以<code>Blob流</code>给Worker调用，不用将Worker独立出一个静态文件。</p></blockquote><h3 id="wasm"><a class="header-anchor" href="#wasm" aria-hidden="true">#</a> wasm</h3><p>hash计算可以直接使用js的库<code>spark-md5</code>或者<code>rust md5</code>生成hash值。</p><p>经过多次测试，使用rust计算速率提高<code>30%</code>。</p><div class="language-rust line-numbers-mode"><pre><code><span class="token attribute attr-name">#[wasm_bindgen]</span>
<span class="token keyword">impl</span> <span class="token class-name">HashHelper</span> <span class="token punctuation">{</span>
  <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">HashHelper</span><span class="token punctuation">{</span>
    <span class="token class-name">HashHelper</span> <span class="token punctuation">{</span>
      ctx<span class="token punctuation">:</span> <span class="token namespace">md5<span class="token punctuation">::</span></span><span class="token class-name">Context</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">append</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">consume</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">end</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">JsString</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> digest <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> hex<span class="token punctuation">:</span> <span class="token class-name">JsString</span> <span class="token operator">=</span> <span class="token class-name">JsString</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">&quot;{:x}&quot;</span><span class="token punctuation">,</span> digest<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">JsString</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span>hex<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h3 id="wasm-worker"><a class="header-anchor" href="#wasm-worker" aria-hidden="true">#</a> wasm + worker</h3><p>wasm运行的时候还是使用js的主进程，还是会阻塞UI。所以继续引入<code>worker</code>来解决问题。</p><ol><li>生成的js胶水代码需要在运行时指定wasm文件URL</li></ol><div class="language-sh line-numbers-mode"><pre><code>wasm-pack build --target no-modules
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="2"><li>引入wasm并使用wasm作为hash计算器。</li></ol><div class="language-ts line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><div class="highlighted"> </div><br><div class="highlighted"> </div><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br></div><pre><code><span class="token keyword">const</span> sparkSite <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token constant">URL</span></span><span class="token punctuation">(</span><span class="token string">&quot;../third/wasm/hash/hash.js&quot;</span><span class="token punctuation">,</span> <span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
<span class="token keyword">const</span> wasmSite <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token constant">URL</span></span><span class="token punctuation">(</span><span class="token string">&#39;../third/wasm/hash/hash_bg.wasm&#39;</span><span class="token punctuation">,</span> <span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
<span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token function">callWorker</span><span class="token punctuation">(</span>
  <span class="token punctuation">[</span>
    <span class="token comment">// 引入wasm</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">self.importScripts(&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>sparkSite<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;);\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token comment">// 初始化wasm</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">wasm_bindgen(&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>wasmSite<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;).then(() =&gt; this.postMessage({ action: &quot;init&quot; }));\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token comment">// 替换使用hash计算器</span>
  <span class="token punctuation">(</span>script<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> script<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>
    <span class="token string">&quot;new this.SparkMD5.ArrayBuffer()&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;wasm_bindgen.HashHelper.new()&quot;</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><ol start="3"><li>由于初始化wasm是异步的，所以等待加载完wasm再执行hash计算。</li></ol><div class="language-ts line-numbers-mode"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><br><br><br><br></div><pre><code>worker<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">.</span>action<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">&quot;init&quot;</span><span class="token operator">:</span>
      worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span> file <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">break</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="切片上传"><a class="header-anchor" href="#切片上传" aria-hidden="true">#</a> 切片上传</h2><p>上传大文件主要做的工作是<code>文件切片</code>，充分利用网络资源。</p><blockquote><ul><li>在处理<code>文件切片大小</code>问题应该根据当前网络环境进行动态分配<code>SIZE</code>。 比如A用户网速为<code>1000MB</code>如果<code>SIZE=10MB</code>该用户每个请求都是马上完成的，则多次建立连接的资源衰耗也特别大，通过参照<code>tcp慢启动策略</code>对<code>SIZE</code>进行动态更新文件切片大小。</li><li>大文件由于切片过多，过多的HTTP链接与会使浏览器卡顿，<code>控制异步请求的并发数</code>并允许上传<code>错误重试</code>限制上传资源使用。</li></ul></blockquote><h3 id="动态切片"><a class="header-anchor" href="#动态切片" aria-hidden="true">#</a> 动态切片</h3><ol><li>文件分片首先要过滤掉上次上传的文件分片，只上传未上传的分片。</li></ol><p>对已经上传的分片打上<code>pass</code>标记</p><p>对未上传的分片打上<code>ready</code>标记</p><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">function</span> <span class="token function">filterUploadedFileChunks</span><span class="token punctuation">(</span>
  file<span class="token operator">:</span> File<span class="token punctuation">,</span>
  uploadedFileList<span class="token operator">:</span> FileChunkDesc<span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span><span class="token operator">:</span> FileChunk<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>uploadedFileList<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> fileChunks<span class="token operator">:</span> FileChunk<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      startIdx<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      endIdx<span class="token operator">:</span> file<span class="token punctuation">.</span>size<span class="token punctuation">,</span>
      status<span class="token operator">:</span> <span class="token string">&quot;ready&quot;</span><span class="token punctuation">,</span>
      chunk<span class="token operator">:</span> file<span class="token punctuation">,</span>
      filename<span class="token operator">:</span> file<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> fileChunks
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> fileChunks<span class="token operator">:</span> FileChunk<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> <span class="token function-variable function">push</span> <span class="token operator">=</span> <span class="token punctuation">(</span>startIdx<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> endIdx<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> status<span class="token operator">:</span> UploadStatus<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    fileChunks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      startIdx<span class="token punctuation">,</span> endIdx<span class="token punctuation">,</span> status<span class="token punctuation">,</span>
      chunk<span class="token operator">:</span> file<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>startIdx<span class="token punctuation">,</span> endIdx<span class="token punctuation">)</span><span class="token punctuation">,</span>
      filename<span class="token operator">:</span> file<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> endIdx <span class="token operator">=</span> uploadedFileList
    <span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> a<span class="token punctuation">.</span>startIdx <span class="token operator">-</span> b<span class="token punctuation">.</span>startIdx<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>prev<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>next<span class="token punctuation">.</span>startIdx <span class="token operator">&gt;</span> prev<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">push</span><span class="token punctuation">(</span>prev<span class="token punctuation">,</span> next<span class="token punctuation">.</span>startIdx<span class="token punctuation">,</span> <span class="token string">&quot;ready&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token function">push</span><span class="token punctuation">(</span>next<span class="token punctuation">.</span>startIdx<span class="token punctuation">,</span> next<span class="token punctuation">.</span>endIdx<span class="token punctuation">,</span> <span class="token string">&quot;pass&quot;</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> next<span class="token punctuation">.</span>endIdx
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span>size <span class="token operator">&gt;</span> endIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">push</span><span class="token punctuation">(</span>endIdx<span class="token punctuation">,</span> file<span class="token punctuation">.</span>size<span class="token punctuation">,</span> <span class="token string">&quot;ready&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> fileChunks
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><ol start="2"><li>对未上传的文件分片再进行处理</li></ol><ul><li>文件分片存在<code>pass</code>标记则跳过上传，对大切片进行二次切片</li><li>切片需要根据当前网速进行，使用<code>generator</code>进行切片，每次调用<code>next</code>都传入切片大小，根据传入的切片大小动态更改下次切片大小。</li></ul><div class="language-ts line-numbers-mode"><div class="highlight-lines"><br><br><div class="highlighted"> </div><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><div class="highlighted"> </div><br><br><br><br></div><pre><code><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">dynamicSize</span><span class="token punctuation">(</span>
  file<span class="token operator">:</span> File<span class="token punctuation">,</span>
  fileChunks<span class="token operator">:</span> FileChunk<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  fileOffset<span class="token operator">:</span> <span class="token builtin">number</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Iterator<span class="token operator">&lt;</span>FileChunk<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token punctuation">,</span> <span class="token builtin">number</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> idx <span class="token operator">&lt;</span> fileChunks<span class="token punctuation">.</span>length<span class="token punctuation">;</span> idx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> fileChunk <span class="token operator">=</span> fileChunks<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fileChunk<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token string">&quot;pass&quot;</span><span class="token punctuation">)</span> <span class="token keyword">continue</span>
    <span class="token keyword">const</span> size <span class="token operator">=</span> fileChunk<span class="token punctuation">.</span>endIdx <span class="token operator">-</span> fileChunk<span class="token punctuation">.</span>startIdx
    <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&gt;</span> fileOffset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// slice</span>
      <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> cur <span class="token operator">=</span> fileChunk<span class="token punctuation">.</span>startIdx<span class="token punctuation">;</span> cur <span class="token operator">&lt;</span> fileChunk<span class="token punctuation">.</span>endIdx<span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> curEnd <span class="token operator">=</span> cur <span class="token operator">+</span> fileOffset <span class="token operator">&gt;</span> fileChunk<span class="token punctuation">.</span>endIdx <span class="token operator">?</span> fileChunk<span class="token punctuation">.</span>endIdx <span class="token operator">:</span> cur <span class="token operator">+</span> fileOffset
        <span class="token keyword">const</span> newOffset <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token punctuation">{</span>
          startIdx<span class="token operator">:</span> cur<span class="token punctuation">,</span>
          endIdx<span class="token operator">:</span> curEnd<span class="token punctuation">,</span>
          status<span class="token operator">:</span> <span class="token string">&quot;ready&quot;</span><span class="token punctuation">,</span>
          chunk<span class="token operator">:</span> file<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>cur<span class="token punctuation">,</span> curEnd<span class="token punctuation">)</span><span class="token punctuation">,</span>
          filename<span class="token operator">:</span> file<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
        cur <span class="token operator">=</span> curEnd
        fileOffset <span class="token operator">=</span> newOffset
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> newOffset <span class="token operator">=</span> <span class="token keyword">yield</span> fileChunk
      fileOffset <span class="token operator">=</span> newOffset
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><ol start="3"><li>根据网速计算切片大小</li></ol><p>根据上传速度动态计算切片大小，类似<code>tcp慢启动</code>优化策略，当拥塞发生时，窗口的减小是成倍（1/2）减小，在网络恢复时，窗口的增大是缓慢增大的，所以叫做慢启动。检测当前环境的资源动态动态扩大或缩小文件切片大小，加快上传速度。</p><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">function</span> <span class="token function">resize</span><span class="token punctuation">(</span>offset<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> start<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> time <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> rate <span class="token operator">=</span> time <span class="token operator">/</span> <span class="token number">5</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>rate <span class="token operator">&lt;</span> <span class="token number">0.5</span><span class="token punctuation">)</span> rate <span class="token operator">=</span> <span class="token number">0.5</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>rate <span class="token operator">&gt;</span> <span class="token number">2</span><span class="token punctuation">)</span> rate <span class="token operator">=</span> <span class="token number">2</span>
  offset <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>offset <span class="token operator">/</span> rate<span class="token punctuation">)</span>
  <span class="token keyword">return</span> offset
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="网络请求【并发、错误重试】请求控制"><a class="header-anchor" href="#网络请求【并发、错误重试】请求控制" aria-hidden="true">#</a> 网络请求【并发、错误重试】请求控制</h3><p>多文件上传的网络请求，需要额外控制。</p><ul><li>请求错误的时候，需要重新发起当前切片的上传请求。</li><li>每次请求都要计算上传时间，并根据时间重新确定切片大小。</li></ul><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">requestResizeChunk</span> <span class="token punctuation">(</span>
  chunk<span class="token operator">:</span> FileChunk<span class="token punctuation">,</span>
  offset<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
  uploadAPI<span class="token operator">:</span> UploadAPI<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> resp<span class="token operator">:</span> <span class="token builtin">any</span>
  <span class="token keyword">let</span> errorTimes <span class="token operator">=</span> <span class="token number">3</span>
  <span class="token keyword">let</span> start<span class="token operator">:</span> <span class="token builtin">number</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>errorTimes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    start <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      resp <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">uploadAPI</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span>
      chunk<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">&quot;uploaded&quot;</span>
      <span class="token keyword">break</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      resp <span class="token operator">=</span> error
      chunk<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">&quot;ready&quot;</span>
      errorTimes<span class="token operator">--</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>chunk<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token string">&quot;ready&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    chunk<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">&quot;error&quot;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> fileOffset <span class="token operator">=</span> <span class="token function">resize</span><span class="token punctuation">(</span>offset<span class="token punctuation">,</span> start<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span> resp<span class="token punctuation">,</span> fileOffset <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>建立特别多的tcp的连接，使浏览器卡顿，并发请求的数量需要控制在一定范围。</p><p>上传的文件切片通过上述的<code>generator</code>生成，更改的切片大小由上述的<code>requestResizeChunk</code>进行计算，获得的切片大小是最新返回的计算结果。</p><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">function</span> <span class="token function">requestWithConcurrent</span> <span class="token punctuation">(</span>
  chunkItor<span class="token operator">:</span> Iterator<span class="token operator">&lt;</span>FileChunk<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token punctuation">,</span> <span class="token builtin">number</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  fileOffset<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
  uploadAPI<span class="token operator">:</span> UploadAPI<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> max <span class="token operator">=</span> <span class="token number">4</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Promise</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">const</span> <span class="token function-variable function">next</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> chunkItorResult <span class="token operator">=</span> chunkItor<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>fileOffset<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>chunkItorResult<span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>max <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 最后一个线程返回</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          max<span class="token operator">--</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">const</span> chunk <span class="token operator">=</span> chunkItorResult<span class="token punctuation">.</span>value <span class="token keyword">as</span> FileChunk
      <span class="token function">requestResizeChunk</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> fileOffset<span class="token punctuation">,</span> uploadAPI<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>res <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          fileOffset <span class="token operator">=</span> res<span class="token punctuation">.</span>fileOffset
          result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>resp<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token keyword">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">Array</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h2 id="断点续传"><a class="header-anchor" href="#断点续传" aria-hidden="true">#</a> 断点续传</h2><p>断点续传的原理在于前端/服务端需要记住已上传的切片，这样下次上传就可以跳过之前已上传的部分。</p><ul><li>不使用<code>浏览器保存</code>，防止刷新页面/换浏览器丢失上传记录，服务端需要配合返回已上传文件切片。</li><li>不使用<code>xhr.abort()</code>停止上传任务，因为这个方法会清空js的调用栈，通过<code>任务读取取消标记</code>控制停止上传行为。</li></ul><h3 id="标记断点-hash计算worker"><a class="header-anchor" href="#标记断点-hash计算worker" aria-hidden="true">#</a> 标记断点 - hash计算worker</h3><p>直接关闭worker</p><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">function</span> <span class="token function">stop</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// stop worker</span>
  worker<span class="token operator">?.</span><span class="token function">terminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// promise return</span>
  ob<span class="token operator">?.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="标记断点-上传任务队列"><a class="header-anchor" href="#标记断点-上传任务队列" aria-hidden="true">#</a> 标记断点 - 上传任务队列</h3><p>添加标记，在上传任务安全退出后才能重新启动上传。</p><div class="language-ts line-numbers-mode"><pre><code>
<span class="token keyword">let</span> canceled <span class="token operator">=</span> <span class="token boolean">false</span>

<span class="token keyword">function</span> <span class="token function">stop</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  canceled <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">slowStart</span><span class="token punctuation">(</span>file<span class="token operator">:</span> File<span class="token punctuation">,</span> uploadedFileList<span class="token operator">:</span> FileChunkDesc<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> uploadAPI<span class="token operator">:</span> UploadAPI<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> fileOffset <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token comment">// file chunks start 10M start</span>
  <span class="token keyword">const</span> fileChunks <span class="token operator">=</span> <span class="token function">filterUploadedFileChunks</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> uploadedFileList<span class="token punctuation">)</span>
  <span class="token keyword">const</span> fileChunksIteror <span class="token operator">=</span> <span class="token function">dynamicSize</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> fileChunks<span class="token punctuation">,</span> fileOffset<span class="token punctuation">)</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">requestWithConcurrent</span><span class="token punctuation">(</span>fileChunksIteror<span class="token punctuation">,</span> fileOffset<span class="token punctuation">,</span> uploadAPI<span class="token punctuation">)</span>
  canceled <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>修改<code>requestWithConcurrent</code>每次发请求都判断当前上传是否被取消</p><div class="language-ts line-numbers-mode"><pre><code><span class="token function">requestResizeChunk</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> fileOffset<span class="token punctuation">,</span> uploadAPI<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>res <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    fileOffset <span class="token operator">=</span> res<span class="token punctuation">.</span>fileOffset
    result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>resp<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token keyword">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>canceled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      chunkItor<span class="token punctuation">.</span><span class="token keyword">return</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="续传"><a class="header-anchor" href="#续传" aria-hidden="true">#</a> 续传</h3><p>等待上述停止动作都执行完成后，重新执行启动上传机会按流程重新开始上传。</p><h2 id="canvas实现进度条"><a class="header-anchor" href="#canvas实现进度条" aria-hidden="true">#</a> canvas实现进度条</h2><p>因为文件分片粒度可能特别小，而且上传分片位置不确定，使用<code>canvas</code>绘制的进度条更加直观的查看【已经上传、错误上传、多任务正在上传、上传成功】的状态。</p><div class="language-ts line-numbers-mode"><pre><code><span class="token keyword">function</span> <span class="token function">drawPercent</span><span class="token punctuation">(</span>start<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> end<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> status<span class="token operator">:</span> UploadStatus<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> x1 <span class="token operator">=</span> start <span class="token operator">*</span> <span class="token number">500</span> <span class="token operator">/</span> uploadState<span class="token punctuation">.</span>size
  <span class="token keyword">const</span> x2 <span class="token operator">=</span> end <span class="token operator">*</span> <span class="token number">500</span> <span class="token operator">/</span> uploadState<span class="token punctuation">.</span>size
  <span class="token keyword">switch</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">&quot;pass&quot;</span><span class="token operator">:</span> ctx<span class="token punctuation">.</span>value<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token string">&quot;#45c23a&quot;</span><span class="token punctuation">;</span> <span class="token keyword">break</span>
    <span class="token keyword">case</span> <span class="token string">&quot;ready&quot;</span><span class="token operator">:</span> ctx<span class="token punctuation">.</span>value<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token string">&quot;#666666&quot;</span><span class="token punctuation">;</span> <span class="token keyword">break</span>
    <span class="token keyword">case</span> <span class="token string">&quot;uploading&quot;</span><span class="token operator">:</span> ctx<span class="token punctuation">.</span>value<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token string">&quot;#0088ff&quot;</span><span class="token punctuation">;</span> <span class="token keyword">break</span>
    <span class="token keyword">case</span> <span class="token string">&quot;uploaded&quot;</span><span class="token operator">:</span> ctx<span class="token punctuation">.</span>value<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token string">&quot;#45c23a&quot;</span><span class="token punctuation">;</span> <span class="token keyword">break</span>
    <span class="token keyword">case</span> <span class="token string">&quot;error&quot;</span><span class="token operator">:</span> ctx<span class="token punctuation">.</span>value<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token string">&quot;#bc1717&quot;</span><span class="token punctuation">;</span> <span class="token keyword">break</span>
  <span class="token punctuation">}</span>
  ctx<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>x1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>x2 <span class="token operator">-</span> x1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div></div></div><footer class="page-footer" data-v-d36a7fda data-v-5a019cc9><div class="edit" data-v-5a019cc9><div class="edit-link" data-v-5a019cc9 data-v-3ae295f1><!----></div></div><div class="updated" data-v-5a019cc9><p class="last-updated" data-v-5a019cc9 data-v-52854a16><span class="prefix" data-v-52854a16>Last Updated:</span><span class="datetime" data-v-52854a16></span></p></div></footer><div class="next-and-prev-link" data-v-d36a7fda data-v-6683615c><div class="container" data-v-6683615c><div class="prev" data-v-6683615c><!----></div><div class="next" data-v-6683615c><a class="link" href="/shared/service/pagination-select" data-v-6683615c><span class="text" data-v-6683615c>跨页选择器</span><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon icon-next" data-v-6683615c><path d="M19.9,12.4c0.1-0.2,0.1-0.5,0-0.8c-0.1-0.1-0.1-0.2-0.2-0.3l-7-7c-0.4-0.4-1-0.4-1.4,0s-0.4,1,0,1.4l5.3,5.3H5c-0.6,0-1,0.4-1,1s0.4,1,1,1h11.6l-5.3,5.3c-0.4,0.4-0.4,1,0,1.4c0.2,0.2,0.5,0.3,0.7,0.3s0.5-0.1,0.7-0.3l7-7C19.8,12.6,19.9,12.5,19.9,12.4z"></path></svg></a></div></div></div><!--[--><!--]--></div></main></div><!----><!--]--></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"index.md\":\"3ce5cbfc\",\"service_index.md\":\"9f023e3f\",\"service_pagination-select.md\":\"db0a80c6\",\"service_upload.md\":\"4e5acb2e\",\"util_diff.md\":\"8f880ef5\",\"util_index.md\":\"48c72fc2\",\"util_indexeddb.md\":\"effa0cef\",\"util_kv.md\":\"d604c1c1\",\"util_promise.md\":\"c7189c2a\",\"util_worker.md\":\"acf18374\"}")</script>
    <script type="module" async src="/shared/assets/app.82ec9553.js"></script>
  </body>
</html>